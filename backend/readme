# AI èŠå¤©åº”ç”¨åç«¯

ä¸€ä¸ªåŸºäº FastAPI çš„æ™ºèƒ½èŠå¤©åº”ç”¨åç«¯ï¼Œæ”¯æŒ AI å¯¹è¯ã€å›¾ç‰‡ç”Ÿæˆã€Agent æ™ºèƒ½ä½“ç­‰åŠŸèƒ½ã€‚

## ğŸ“‹ ç›®å½•

- [åŠŸèƒ½ç‰¹æ€§](#åŠŸèƒ½ç‰¹æ€§)
- [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
- [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [API æ–‡æ¡£](#api-æ–‡æ¡£)
- [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
- [å¼€å‘æŒ‡å—](#å¼€å‘æŒ‡å—)

## âœ¨ åŠŸèƒ½ç‰¹æ€§

### 1. ç”¨æˆ·è®¤è¯
- ç”¨æˆ·æ³¨å†Œå’Œç™»å½•
- JWT Token è®¤è¯
- å¯†ç åŠ å¯†å­˜å‚¨

### 2. AI èŠå¤©åŠŸèƒ½
- **æµå¼å“åº”**ï¼šæ”¯æŒ Server-Sent Events (SSE) æµå¼è¾“å‡º
- **æ·±åº¦æ€è€ƒ**ï¼šæ”¯æŒ AI æ¨¡å‹çš„æ·±åº¦æ€è€ƒèƒ½åŠ›ï¼ˆreasoningï¼‰
- **å›¾ç‰‡ä¸Šä¼ **ï¼šæ”¯æŒç”¨æˆ·ä¸Šä¼ å›¾ç‰‡è¿›è¡Œè§†è§‰åˆ†æ
- **å›¾ç‰‡ç”Ÿæˆ**ï¼šæ”¯æŒæ–‡æœ¬ç”Ÿæˆå›¾ç‰‡ã€ä»¥å›¾ç”Ÿå›¾ã€å›¾ç‰‡ä¿®æ”¹ç­‰åŠŸèƒ½
- **æ„å›¾è¯†åˆ«**ï¼šè‡ªåŠ¨è¯†åˆ«ç”¨æˆ·æ„å›¾ï¼ˆæ–‡ä»¶è§£æã€å›¾ç‰‡ç”Ÿæˆã€æ™®é€šå¯¹è¯ï¼‰
- **ä¼šè¯ç®¡ç†**ï¼šæ”¯æŒå¤šä¼šè¯ç®¡ç†ï¼Œæ¯ä¸ªä¼šè¯åŒ…å«å®Œæ•´çš„å¯¹è¯å†å²

### 3. Agent æ™ºèƒ½ä½“ç³»ç»Ÿ
- **Agent åˆ›å»º**ï¼šç”¨æˆ·å¯ä»¥åˆ›å»ºè‡ªå®šä¹‰çš„ AI Agent
- **è®°å¿†ç®¡ç†**ï¼šè‡ªåŠ¨æ€»ç»“èŠå¤©å†å²ï¼Œå½¢æˆé•¿æœŸè®°å¿†
- **çŸ¥è¯†åº“æ£€ç´¢**ï¼šæ”¯æŒæŒ‰æ—¥æœŸã€å…³é”®è¯æ£€ç´¢ Agent çš„çŸ¥è¯†åº“
- **Prompt å†å²**ï¼šè®°å½• Prompt çš„æ¼”è¿›è¿‡ç¨‹ï¼Œæ”¯æŒåˆ é™¤æœ€æ–°æ€»ç»“
- **æ‰¹é‡æ¶ˆæ¯å¤„ç†**ï¼šæ”¯æŒæ‰¹é‡å‘é€æ¶ˆæ¯ï¼ŒAI å¯ä»¥æŒ‰é¡ºåºå»¶è¿Ÿå›å¤

### 4. æ•°æ®åº“æ¨¡å‹
- **ç”¨æˆ·æ¨¡å‹**ï¼šç”¨æˆ·åŸºæœ¬ä¿¡æ¯
- **èŠå¤©ä¼šè¯æ¨¡å‹**ï¼šä¼šè¯æ ‡é¢˜ã€åˆ›å»ºæ—¶é—´ç­‰
- **èŠå¤©æ¶ˆæ¯æ¨¡å‹**ï¼šæ¶ˆæ¯å†…å®¹ã€è§’è‰²ã€å›¾ç‰‡ã€æ·±åº¦æ€è€ƒå†…å®¹ç­‰
- **Agent æ¨¡å‹**ï¼šAgent åŸºæœ¬ä¿¡æ¯ã€Prompt ç­‰
- **Agent ä¼šè¯æ¨¡å‹**ï¼šAgent çš„èŠå¤©ä¼šè¯ï¼ˆå•ä¼šè¯æ¨¡å¼ï¼‰
- **Agent æ¶ˆæ¯æ¨¡å‹**ï¼šAgent çš„èŠå¤©æ¶ˆæ¯ï¼Œæ”¯æŒæ‰¹æ¬¡ç®¡ç†
- **Prompt å†å²æ¨¡å‹**ï¼šè®°å½• Prompt çš„æ¼”è¿›
- **çŸ¥è¯†åº“ç´¢å¼•æ¨¡å‹**ï¼šå»ºç«‹æ€»ç»“å†…å®¹ä¸æ—¥æœŸçš„ç´¢å¼•å…³ç³»

## ğŸ›  æŠ€æœ¯æ ˆ

- **æ¡†æ¶**ï¼šFastAPI
- **æ•°æ®åº“**ï¼šSQLiteï¼ˆå¯é…ç½®ä¸º PostgreSQL/MySQLï¼‰
- **ORM**ï¼šSQLAlchemy
- **è®¤è¯**ï¼šJWT (JSON Web Token)
- **AI æœåŠ¡**ï¼šè±†åŒ… APIï¼ˆæ”¯æŒ Chatã€å›¾ç‰‡ç”Ÿæˆç­‰ï¼‰
- **å¼‚æ­¥æ”¯æŒ**ï¼šæ”¯æŒæµå¼å“åº”ï¼ˆSSEï¼‰

## ğŸ“ é¡¹ç›®ç»“æ„

```
backend/app/
â”œâ”€â”€ main.py                 # FastAPI åº”ç”¨å…¥å£
â”œâ”€â”€ run_server.py          # æœåŠ¡å™¨å¯åŠ¨è„šæœ¬
â”œâ”€â”€ config/                # é…ç½®æ¨¡å—
â”‚   â””â”€â”€ settings.py        # åº”ç”¨é…ç½®
â”œâ”€â”€ database/              # æ•°æ®åº“æ¨¡å—
â”‚   â””â”€â”€ session.py         # æ•°æ®åº“ä¼šè¯ç®¡ç†
â”œâ”€â”€ models/                # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ user.py           # ç”¨æˆ·æ¨¡å‹
â”‚   â”œâ”€â”€ chat.py           # èŠå¤©æ¨¡å‹
â”‚   â””â”€â”€ agent.py          # Agent æ¨¡å‹
â”œâ”€â”€ auth/                  # è®¤è¯æ¨¡å—
â”‚   â”œâ”€â”€ routes.py         # è®¤è¯è·¯ç”±
â”‚   â”œâ”€â”€ service.py        # è®¤è¯æœåŠ¡
â”‚   â”œâ”€â”€ schemas.py        # è®¤è¯æ•°æ®æ¨¡å¼
â”‚   â””â”€â”€ deps.py           # ä¾èµ–æ³¨å…¥
â”œâ”€â”€ ai/                    # AI åŠŸèƒ½æ¨¡å—
â”‚   â”œâ”€â”€ routes.py         # AI è·¯ç”±
â”‚   â”œâ”€â”€ service.py        # AI æœåŠ¡
â”‚   â”œâ”€â”€ client.py         # AI å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ intent_detector.py # æ„å›¾è¯†åˆ«
â”‚   â””â”€â”€ image_generator.py # å›¾ç‰‡ç”Ÿæˆ
â”œâ”€â”€ chat/                  # èŠå¤©æ¨¡å—
â”‚   â”œâ”€â”€ routes.py         # èŠå¤©è·¯ç”±
â”‚   â”œâ”€â”€ service.py        # èŠå¤©æœåŠ¡
â”‚   â””â”€â”€ schemas.py        # èŠå¤©æ•°æ®æ¨¡å¼
â”œâ”€â”€ agents/                # Agent æ¨¡å—
â”‚   â”œâ”€â”€ routes.py         # Agent è·¯ç”±
â”‚   â”œâ”€â”€ service.py        # Agent æœåŠ¡
â”‚   â”œâ”€â”€ schemas.py        # Agent æ•°æ®æ¨¡å¼
â”‚   â”œâ”€â”€ agent_t.py        # Agent æ ¸å¿ƒé€»è¾‘
â”‚   â”œâ”€â”€ intent_detector.py # Agent æ„å›¾è¯†åˆ«
â”‚   â””â”€â”€ knowledge_index.py # çŸ¥è¯†åº“æ£€ç´¢
â””â”€â”€ utils/                 # å·¥å…·æ¨¡å—
    â””â”€â”€ security.py       # å®‰å…¨å·¥å…·ï¼ˆå¯†ç åŠ å¯†ã€Token ç”Ÿæˆï¼‰
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Python 3.8+
- pip æˆ– conda

### å®‰è£…æ­¥éª¤

1. **å…‹éš†é¡¹ç›®**ï¼ˆå¦‚æœé€‚ç”¨ï¼‰

2. **å®‰è£…ä¾èµ–**

```bash
pip install -r requirements.txt
```

ä¸»è¦ä¾èµ–åŒ…æ‹¬ï¼š
- `fastapi`
- `uvicorn`
- `sqlalchemy`
- `pydantic`
- `python-jose[cryptography]`
- `passlib[bcrypt]`
- `python-multipart`

3. **é…ç½®ç¯å¢ƒå˜é‡**

åˆ›å»º `.env` æ–‡ä»¶ï¼ˆå¯é€‰ï¼Œä¼šè¦†ç›–é»˜è®¤é…ç½®ï¼‰ï¼š

```env
SECRET_KEY=your_secret_key_here
SQLALCHEMY_DATABASE_URL=sqlite:///./chatbot.db
ACCESS_TOKEN_EXPIRE_MINUTES=10080
```

4. **é…ç½® AI API**

åœ¨ `ai/client.py` ä¸­é…ç½®ä½ çš„ AI API Key å’Œ Base URLã€‚

5. **å¯åŠ¨æœåŠ¡å™¨**

```bash
# ä½¿ç”¨é»˜è®¤é…ç½®ï¼ˆlocalhost:8000ï¼‰
python run_server.py

# å…è®¸å±€åŸŸç½‘è®¿é—®
python run_server.py --host 0.0.0.0 --port 8000

# å¼€å‘æ¨¡å¼ï¼ˆè‡ªåŠ¨é‡è½½ï¼‰
python run_server.py --reload
```

æˆ–è€…ä½¿ç”¨ uvicorn ç›´æ¥å¯åŠ¨ï¼š

```bash
uvicorn backend.app.main:app --host 0.0.0.0 --port 8000 --reload
```

6. **è®¿é—® API æ–‡æ¡£**

å¯åŠ¨åè®¿é—®ï¼š
- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc

## ğŸ“š API æ–‡æ¡£

### è®¤è¯ API (`/auth`)

- `POST /auth/register` - ç”¨æˆ·æ³¨å†Œ
- `POST /auth/login` - ç”¨æˆ·ç™»å½•
- `GET /auth/me` - è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯

### AI API (`/ai`)

- `POST /ai/ask` - å•æ¬¡ AI é—®ç­”ï¼ˆéæµå¼ï¼‰
- `POST /ai/ask/stream` - æµå¼ AI é—®ç­”ï¼ˆSSEï¼‰

### èŠå¤© API (`/chat`)

- `GET /chat/sessions` - è·å–ä¼šè¯åˆ—è¡¨
- `POST /chat/sessions` - åˆ›å»ºæ–°ä¼šè¯å¹¶å‘é€é¦–æ¡æ¶ˆæ¯
- `POST /chat/sessions/stream` - åˆ›å»ºä¼šè¯å¹¶æµå¼è¿”å›
- `GET /chat/sessions/{session_id}/messages` - è·å–ä¼šè¯æ¶ˆæ¯
- `POST /chat/sessions/{session_id}/messages` - åœ¨ä¼šè¯ä¸­å‘é€æ¶ˆæ¯
- `POST /chat/sessions/{session_id}/messages/stream` - æµå¼å‘é€æ¶ˆæ¯
- `PUT /chat/sessions/{session_id}` - æ›´æ–°ä¼šè¯æ ‡é¢˜
- `DELETE /chat/sessions/{session_id}` - åˆ é™¤ä¼šè¯

### Agent API (`/agents`)

- `GET /agents/` - è·å– Agent åˆ—è¡¨
- `POST /agents/` - åˆ›å»ºæ–° Agent
- `GET /agents/{agent_id}` - è·å– Agent è¯¦æƒ…
- `PUT /agents/{agent_id}` - æ›´æ–° Agent åç§°
- `DELETE /agents/{agent_id}` - åˆ é™¤ Agent
- `GET /agents/{agent_id}/chat` - è·å– Agent èŠå¤©ä¼šè¯
- `POST /agents/{agent_id}/chat/messages/batch` - æ‰¹é‡å‘é€æ¶ˆæ¯
- `GET /agents/{agent_id}/prompt-history` - è·å– Prompt å†å²
- `DELETE /agents/{agent_id}/prompt-history/latest` - åˆ é™¤æœ€æ–° Prompt æ€»ç»“
- `GET /agents/{agent_id}/knowledge/search` - æ£€ç´¢çŸ¥è¯†åº“
- `GET /agents/{agent_id}/knowledge` - è·å–çŸ¥è¯†åº“ç´¢å¼•
- `POST /agents/{agent_id}/chat/clear-and-summarize` - æ¸…ç©ºèŠå¤©å¹¶æ€»ç»“è®°å¿†

## âš™ï¸ é…ç½®è¯´æ˜

### æ•°æ®åº“é…ç½®

é»˜è®¤ä½¿ç”¨ SQLiteï¼Œæ•°æ®åº“æ–‡ä»¶è·¯å¾„åœ¨ `config/settings.py` ä¸­é…ç½®ï¼š

```python
SQLALCHEMY_DATABASE_URL = "sqlite:///E:/PythonProject2/chatbot.db"
```

å¯ä»¥ä¿®æ”¹ä¸º PostgreSQL æˆ– MySQLï¼š

```python
# PostgreSQL
SQLALCHEMY_DATABASE_URL = "postgresql://user:password@localhost/dbname"

# MySQL
SQLALCHEMY_DATABASE_URL = "mysql+pymysql://user:password@localhost/dbname"
```

### JWT é…ç½®

åœ¨ `config/settings.py` ä¸­é…ç½®ï¼š

```python
SECRET_KEY = "your_secret_key_here"  # ç”Ÿäº§ç¯å¢ƒåŠ¡å¿…ä½¿ç”¨éšæœºé•¿å­—ç¬¦ä¸²
ACCESS_TOKEN_EXPIRE_MINUTES = 60 * 24 * 7  # Token æœ‰æ•ˆæœŸï¼š7å¤©
```

### CORS é…ç½®

åœ¨ `main.py` ä¸­é…ç½® CORSï¼Œå½“å‰è®¾ç½®ä¸ºå…è®¸æ‰€æœ‰æ¥æºï¼ˆå¼€å‘ç¯å¢ƒï¼‰ï¼š

```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=False,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

ç”Ÿäº§ç¯å¢ƒåº”é™åˆ¶å…è®¸çš„æ¥æºã€‚

## ğŸ”§ å¼€å‘æŒ‡å—

### æ•°æ®åº“è¿ç§»

é¡¹ç›®ä½¿ç”¨ SQLAlchemy çš„è‡ªåŠ¨å»ºè¡¨åŠŸèƒ½ã€‚é¦–æ¬¡è¿è¡Œæ—¶ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºæ‰€æœ‰è¡¨ï¼š

```python
Base.metadata.create_all(bind=engine)
```

### æ·»åŠ æ–°åŠŸèƒ½

1. **æ·»åŠ æ–°æ¨¡å‹**ï¼šåœ¨ `models/` ç›®å½•ä¸‹åˆ›å»ºæ–°çš„æ¨¡å‹æ–‡ä»¶
2. **æ·»åŠ æ–°è·¯ç”±**ï¼šåœ¨ç›¸åº”çš„æ¨¡å—ä¸‹åˆ›å»º `routes.py` æˆ–æ·»åŠ åˆ°ç°æœ‰è·¯ç”±æ–‡ä»¶
3. **æ·»åŠ æ–°æœåŠ¡**ï¼šåœ¨ç›¸åº”çš„æ¨¡å—ä¸‹åˆ›å»º `service.py` æˆ–æ·»åŠ åˆ°ç°æœ‰æœåŠ¡æ–‡ä»¶
4. **å®šä¹‰æ•°æ®æ¨¡å¼**ï¼šåœ¨ç›¸åº”çš„æ¨¡å—ä¸‹åˆ›å»º `schemas.py` æˆ–æ·»åŠ åˆ°ç°æœ‰æ¨¡å¼æ–‡ä»¶

### æ—¥å¿—é…ç½®

é¡¹ç›®ä½¿ç”¨ Python æ ‡å‡†åº“ `logging` æ¨¡å—ã€‚æ—¥å¿—çº§åˆ«å¯ä»¥åœ¨ä»£ç ä¸­é…ç½®ï¼š

```python
logging.basicConfig(level=logging.DEBUG)
```

### æµ‹è¯•

å¯ä»¥åˆ›å»ºæµ‹è¯•æ–‡ä»¶è¿›è¡ŒåŠŸèƒ½æµ‹è¯•ï¼š

```bash
python test.py
```

## ğŸ‘¥ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼


